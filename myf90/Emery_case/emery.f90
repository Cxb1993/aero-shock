PROGRAM MACHSTEP
IMPLICIT NONE
REAL, DIMENSION (32,32,400,400) :: F,FEQ
REAL, DIMENSION (400,400)       :: UX,UY,Z,T,R,ET,P,FN,FNL,THA,THB,PHIA,PHIB
REAL, DIMENSION (400,400)       :: RHS,RHSL,FLL,FLH,FL,FHL,FHH,FH,GLL,GLH,GL,GHL,GHH,GH2
REAL, DIMENSION (400)           :: X,Y
REAL, DIMENSION (32)            :: CX,CY,VX,VY,GH,W
real, dimension (400,400,2)     :: RR
CHARACTER *16 FNAM
INTEGER NXT,NYT,NX,NY,NV,I,J,K,L,M,N,ITER,ISTOP,SK,SL,TOTITER,GAP,NUMFILES
INTEGER IWXA,IWXB,IWYA,IWYB,IMEX,XLA,XLB,YLA,YLB,NXL,NYL,FILENO,FILEINDX
INTEGER XR1A,XR1B,YR1A,YR1B,NXR1,NYR1
INTEGER XR2A,XR2B,YR2A,YR2B,NXR2,NYR2
INTEGER XR3A,XR3B,YR3A,YR3B,NXR3,NYR3
INTEGER iz
INTEGER XSALL,XFALL,YSALL,YFALL
REAL(8) CFL,TIME,OUTTIME,RES,NORMRES
REAL(8)	LX,LY,R_TIME,PI,Z1,UX1,UY1,T1,Z2,UX2,UY2,T2
REAL(8)	DX,DY,VXP,VXM,VYP,VYM,DTDY,DTDX,DTCFL
REAL(8)	SR,SUX,SUY,SE
REAL(8) THETA,PP,DT
	
	!DOMAIN
	!||   NXT	!!
    !||   NYT	!!
    NXT          = 172					     
	NYT          = 52 
	IMEX		 = 1
	! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ !
	! IMEX: 0 = EXPLICIT; 1 = IMPLICIT !
	! ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ !
    CFL         = 0.99
    OUTTIME     = 2.0
    THETA       = 1
    NV = 32
	R_TIME = 0.1 
    PI = ATAN2(1.,1.)*4.

OPEN (UNIT = 100, FILE = 'RESIDUAL.TEC', STATUS = 'UNKNOWN')
OPEN (UNIT = 200, FILE = 'RESULTS.TEC', STATUS = 'UNKNOWN')
OPEN (UNIT = 300, FILE = 'TEST.TEC', STATUS = 'UNKNOWN')
999 FORMAT ('VARIABLES = "TIME","RESIDUAL"')
WRITE(100,999)
888 FORMAT ('VARIABLES = "X","Y","N","UX","UY","P","T","Z"')
! GAUSS-HERMITE QUADRATURE	 !
!GH(1:5)   =(/-5.38748089001,-4.60368244955,-3.94476404012,-3.34785456738,-2.78880605843/)
!GH(6:10)  =(/-2.25497400209,-1.73853771212,-1.2340762154,-0.737473728545,-0.245340708301/)
!GH(11:15) =(/0.245340708301,0.737473728545,1.2340762154,1.73853771212,2.25497400209/)
!GH(16:20) =(/2.78880605843,3.34785456738,3.94476404012,4.60368244955,5.38748089001/)
!W (1:5)	  =(/0.898591961453,0.704332961176,0.62227869619,0.575262442852,0.544851742366/)
!W (6:10)  =(/0.524080350949,0.509679027117,0.499920871336,0.493843385272,0.490921500667/)
!W (11:15) =(/0.490921500667,0.493843385272,0.499920871336,0.509679027117,0.524080350949/)
!W (16:20) =(/0.544851742366,0.575262442852,0.62227869619,0.704332961176,0.898591961453/)
GH(1:5)   =(/-7.12581390983,-6.40949814928,-5.81222594946,-5.27555098664,-4.77716450334/)
GH(6:10)  =(/-4.30554795347,-3.85375548542,-3.41716749282,-2.99249082501,-2.57724953773/)
GH(11:15) =(/-2.16949918361,-1.76765410946,-1.37037641095,-0.97650046359,-0.584978765436/)
GH(16:20) =(/-0.194840741569,0.194840741569,0.584978765436,0.97650046359,1.37037641095/)
GH(21:25) =(/1.76765410946,2.16949918361,2.57724953773,2.99249082501,3.41716749282/)
GH(26:30) =(/3.85375548542,4.30554795347,4.77716450334,5.27555098664,5.81222594946/)
GH(31:32) =(/6.40949814928,7.12581390983/)
W (1:5)	  =(/0.824566523071,0.640950485906,0.561749015435,0.515037283347,0.48357144163/)
W (6:10)  =(/0.460786455454,0.443553185862,0.430163710393,0.419597752949,0.411206128685/)
W (11:15) =(/0.404557061809,0.399354844618,0.395393939396,0.392531864366,0.390672744629/)
W (16:20) =(/0.389757342027,0.389757342027,0.390672744629,0.392531864366,0.395393939396/)
W (21:25) =(/0.399354844618,0.404557061809,0.411206128685,0.419597752949,0.430163710393/)
W (26:30) =(/0.443553185862,0.460786455454,0.48357144163,0.515037283347,0.561749015435/)
W (31:32) =(/0.640950485906,0.824566523071/)
    DO I = 1, NV
      CX(I)    = W(I)
      VX(I)    = GH(I)
	  CY(I)    = W(I)
      VY(I)    = GH(I)  
    END DO 
!
    Z1   = 0.311943688   ! N1 = 0.4
    UX1  = 3.5		  !	P1 = 0.2
    UY1  = 0.
    T1   = 1.42857143		
!    
    Z2   = 0.1
    UX2  = 0.
    UY2  = 0.
    T2   = 0.5 
! 	
	LX = 3.4
	LY = 1.    
	NX = NXT-2
	NY = NYT-2
    DX = LX/DFLOAT(NX-1)
    DY = LY/DFLOAT(NY-1)
    X(1)  = 0.-DX
    Y(1)  = 0.-DY
    DO I = 2,NXT
        X(I) = X(I-1) + DX
    END DO
    DO J = 2, NYT
        Y(J) = Y(J-1) + DY   
    END DO
	! DELTA TIME
	DT = MIN(DX,DY) * CFL/VX(NV) 
	TOTITER = FLOOR(OUTTIME/DT)
	NUMFILES = 50
	GAP = TOTITER/NUMFILES	+1
	IF (TOTITER .LT. NUMFILES) THEN
	NUMFILES = TOTITER
	END IF
	!WRITE(*,*) 'APPROX ITER:',TOTITER,'APPROX NO. FILES:',NUMFILES
	DO I = 1,NUMFILES
	WRITE(FNAM,300) I
	!WRITE(6,*) FNAM
	OPEN(I,FILE=FNAM)
	WRITE(I,888)
	!CLOSE(I)
	END DO
300 FORMAT ('OUTPUT',I3.3,'.TEC')
	XSALL   = 2						! INTEGERS OF COMP. DOMAIN
	XFALL   = NX+XSALL-1
	YSALL   = 2
	YFALL   = NY+YSALL-1
	!
	XLA		= XSALL
	XLB		= ((5*NX/17)) + XLA - 1
	NXL		= XLB - XLA + 1
	YLA		= YSALL
	YLB		= YLA + NY - 1
	NYL		= YLB - YLA + 1
	!
	XR1A	= XLB+1
	XR1B	= XR1A + (4*NX/17) - 1
	NXR1	= XR1B - XR1A +1 
	YR1A	= YSALL + NY/5
	YR1B	= YLB
	NYR1	= YR1B - YR1A + 1
	!
	NXR2	= NXR1
	XR2A	= XR1B + 1
	XR2B    = XR2A + NXR2 - 1
	NYR2	= NYR1
	YR2A	= YR1A
	YR2B	= YR1B
	!
	NXR3	= NXR2
	XR3A	= XR2B + 1
	XR3B	= XR3A + NXR3 - 1
	NYR3	= NYR2
	YR3A	= YR2A
	YR3B	= YR2B
	!
	IWXA	= XLB+1					! INTEGERS OF SOLID WALL
	IWXB	= XFALL+1
	IWYA	= YSALL-1
	IWYB	= YR1A - 1
WRITE(300,*) ('VARIABLES = "X","Y"')
	!
WRITE(300,*) 'ZONE T="L",I=',NYL,',J=',NXL
DO I = XLA,XLB
DO J = YLA,YLB
   WRITE (300,*) X(I),Y(J)
END DO 
END DO
!
WRITE(300,*) 'ZONE T="R1",I=',NYR1,',J=',NXR1+1
DO I = XR1A-1,XR1B
DO J = YR1A,YR1B
   WRITE (300,*) X(I),Y(J)
END DO 
END DO
!
WRITE(300,*) 'ZONE T="R2",I=',NYR2,',J=',NXR2+1
DO I = XR2A-1,XR2B
DO J = YR2A,YR2B
   WRITE (300,*) X(I),Y(J) 
END DO 
END DO
!!
WRITE(300,*) 'ZONE T="R3",I=',NYR3,',J=',NXR3+1
DO I = XR3A-1,XR3B
DO J = YR3A,YR3B
   WRITE (300,*) X(I),Y(J)
END DO 
END DO
! COMPUTATIONAL DOMAIN
DO K = 1, NV
DO L = 1, NV 
	DO I = XSALL-1,XFALL+1
	DO J = YSALL-1,YFALL+1
        Z(I,J) = Z1
        UX(I,J)= UX1
        UY(I,J)= UY1
        T(I,J) = T1
	 PP	= ( (VX(K)-UX(I,J))**2 + (VY(L)-UY(I,J))**2 ) / T(I,J)
	 F(K,L,I,J) = 1/((EXP(PP)/Z(I,J)) + THETA)
    END DO
    END DO    
END DO
END DO
!
ITER  = 1
TIME  = 0
ISTOP = 0
FILENO = 2
FILEINDX = 2
IZ = 1
1000 CONTINUE    
    TIME = TIME + DT
    DTDX = DT/DX
    DTDY = DT/DY     
IF (TIME .GT. OUTTIME) THEN
    DTCFL = OUTTIME - (TIME - DTCFL)  
    TIME = OUTTIME
    DT = DTCFL/CFL
    DTDX = DTCFL / DX
    DTDY = DTCFL / DY
    ISTOP = 1
END IF
! PROJECTION TO EQUILIBRIUM
DO K = 1, NV
DO L = 1, NV	
	DO I = XSALL,XFALL
    DO J = YSALL,YFALL
		IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN 
        PP = ( (VX(K)-UX(I,J))**2 + (VY(L)-UY(I,J))**2 ) / T(I,J)
        FEQ(K,L,I,J) = 1 /((EXP(PP)/Z(I,J))+THETA)
		F(K,L,I,J) = FEQ(K,L,I,J)			
		END IF	
    END DO
    END DO  
END DO
END DO 
!
! FIRST CLASS NORM OF RESIDUAL
DO I = XSALL,XFALL
DO J = YSALL,YFALL
IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
	RR(I,J,IZ) = R(I,J)
END IF
END DO
END DO
!
DO K = 1,NV
DO L = 1,NV
    VXP = MAX(VX(K),0.)
    VXM = MIN(VX(K),0.) 
    VYP = MAX(VY(L),0.)
    VYM = MIN(VY(L),0.) 
    !THETA
    DO I = XSALL,XFALL
    DO J = YSALL,YFALL
	IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
	    IF (F(K,L,I+1,J) .EQ. F(K,L,I,J)) THEN
            THA(I,J) =  0
        ELSE
            IF (VX(K).GE.0) THEN
            SK=1
            ELSE
            SK=-1
            END IF
            THA(I,J)=(F(K,L,I-SK+1,J)-F(K,L,I-SK,J))/(F(K,L,I+1,J)-F(K,L,I,J))
		END IF 
        IF (F(K,L,I,J+1) .EQ. F(K,L,I,J)) THEN
            THB(I,J) =  0
        ELSE
            IF (VY(L).GE.0) THEN
            SL=1
            ELSE
            SL=-1
            END IF
            THB(I,J)=(F(K,L,I,J-SL+1)-F(K,L,I,J-SL))/(F(K,L,I,J+1)-F(K,L,I,J))
	    END IF 		
	END IF		        
    END DO
    END DO 
    DO I = 1,NXT
        THB(I,1)=1
        THB(I,NY)=1
    END DO		      
    DO J = 1,NYT
        THA(1,J)=1
        THA(NX,J)=1
    END DO
    !VAN LEER 	
    DO I = 1,NXT
    DO J = 1,NYT
	IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
		IF (THA(I,J) .LE. 0) THEN
            PHIA(I,J)=0
        ELSE
            PHIA(I,J)= (ABS(THA(I,J))+THA(I,J))/(1+ABS(THA(I,J)))
        END IF
        IF (THB(I,J) .LE. 0) THEN
            PHIB(I,J)=0
        ELSE
            PHIB(I,J)= (ABS(THB(I,J))+THB(I,J))/(1+ABS(THB(I,J)))
        END IF 
	END IF   
    END DO
    END DO
  !*********************!
  !         L           !
  !*********************!
 ! BOTTOM WALL
  DO I = XLA,XLB
	 J = YLA-1
	 PP = ( (VX(K)-UX(I,J+1))**2 + (VY(L)+UY(I,J+1))**2 ) / T(I,J+1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J+1))+THETA)
  END DO
  ! UPPER WALL
  DO I = XLA,XLB
     J = YLB+1
	 PP = ( (VX(K)-UX(I,J-1))**2 + (VY(L)+UY(I,J-1))**2 ) / T(I,J-1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J-1))+THETA)
  END DO
  ! INFLOW BOUNDARY
  DO J = YLA,YLB
    F(K,L,XLA-1,J)=F(K,L,XLA+1,J)
  END DO
  ! WALL BOUNDARY
  DO J = IWYA,IWYB
	 I = XLB+1
	 PP = ( (VX(K)+UX(I-1,J))**2 + (VY(L)-UY(I-1,J))**2 ) / T(I-1,J)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I-1,J))+THETA)
  END DO
  !
  DO I = XLA,XLB
  DO J = YLA,YLB
	    FLL(I,J) = VXP*F(K,L,I-1,J)+VXM*F(K,L,I,J)
        FLH(I,J) = 0.5D0*VX(K)*(F(K,L,I-1,J)+F(K,L,I,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I,J)-F(K,L,I-1,J)) 
        FL(I,J) = FLL(I,J)+ (PHIA(I-1,J)*(FLH(I,J)-FLL(I,J)))
        FHL(I,J) = VXP*F(K,L,I,J)+VXM*F(K,L,I+1,J)
        FHH(I,J) = 0.5D0*VX(K)*(F(K,L,I,J)+F(K,L,I+1,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I+1,J)-F(K,L,I,J)) 
        FH(I,J)  = FHL(I,J)+ (PHIA(I,J)*(FHH(I,J)-FHL(I,J)))
        GLL(I,J) = VYP*F(K,L,I,J-1)+VYM*F(K,L,I,J)
        GLH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J-1)+F(K,L,I,J))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J)-F(K,L,I,J-1))
        GL(I,J)  = GLL(I,J)+ (PHIB(I,J-1)*(GLH(I,J)-GLL(I,J)))
        GHL(I,J) = VYP*F(K,L,I,J)+VYM*F(K,L,I,J+1)
        GHH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J)+F(K,L,I,J+1))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J+1)-F(K,L,I,J))
        GH2(I,J)  = GHL(I,J)+ (PHIB(I,J)*(GHH(I,J)-GHL(I,J)))
		RHS(I,J) = - DTDX*(FH(I,J)-FL(I,J)) - DTDY*(GH2(I,J)-GL(I,J)) !+ DT*(FEQ(K,L,I,J)-F(K,L,I,J))/R_TIME
	END DO
	END DO 	
	IF (IMEX .GT. 0) THEN
	DO I = XLA,XLB
	DO J = YLA,YLB
	 M = I - XLA + 1
	 N = J - YLA + 1
	 RHSL(M,N) = RHS(I,J)
	END DO
	END DO
		
	CALL IMPLICIT_MTD (XLA,XLB,YLA,YLB,NXL,NYL,K,L,VXP,VYP,VXM,VYM,DT,RHSL,F,FNL)	 
	DO I = XLA,XLB
	DO J = YLA,YLB
	 M = I - XLA + 1
	 N = J - YLA + 1
	 FN(I,J) = FNL(M,N)
	END DO
	END DO
	ELSE
	DO I = XLA,XLB
	DO J = YLA,YLB
	 FN(I,J) = F(K,L,I,J) + RHS(I,J)
	END DO
	END DO
	END IF
  !*******************!
  !         R1        !
  !*******************!
  ! BOTTOM WALL
  DO I = XR1A,XR1B
	 J = IWYB
	 PP = ( (VX(K)-UX(I,J+1))**2 + (VY(L)+UY(I,J+1))**2 ) / T(I,J+1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J+1))+THETA)
  END DO
  ! UPPER WALL
  DO I = XR1A,XR1B
     J = YR1B + 1
	 PP = ( (VX(K)-UX(I,J-1))**2 + (VY(L)+UY(I,J-1))**2 ) / T(I,J-1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J-1))+THETA)
  END DO 
  DO I = XR1A,XR1B
  DO J = YR1A,YR1B
	    FLL(I,J) = VXP*F(K,L,I-1,J)+VXM*F(K,L,I,J)
        FLH(I,J) = 0.5D0*VX(K)*(F(K,L,I-1,J)+F(K,L,I,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I,J)-F(K,L,I-1,J)) 
        FL(I,J) = FLL(I,J)+ (PHIA(I-1,J)*(FLH(I,J)-FLL(I,J)))
        FHL(I,J) = VXP*F(K,L,I,J)+VXM*F(K,L,I+1,J)
        FHH(I,J) = 0.5D0*VX(K)*(F(K,L,I,J)+F(K,L,I+1,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I+1,J)-F(K,L,I,J)) 
        FH(I,J)  = FHL(I,J)+ (PHIA(I,J)*(FHH(I,J)-FHL(I,J)))
        GLL(I,J) = VYP*F(K,L,I,J-1)+VYM*F(K,L,I,J)
        GLH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J-1)+F(K,L,I,J))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J)-F(K,L,I,J-1))
        GL(I,J)  = GLL(I,J)+ (PHIB(I,J-1)*(GLH(I,J)-GLL(I,J)))
        GHL(I,J) = VYP*F(K,L,I,J)+VYM*F(K,L,I,J+1)
        GHH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J)+F(K,L,I,J+1))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J+1)-F(K,L,I,J))
        GH2(I,J)  = GHL(I,J)+ (PHIB(I,J)*(GHH(I,J)-GHL(I,J)))
		RHS(I,J) = - DTDX*(FH(I,J)-FL(I,J)) - DTDY*(GH2(I,J)-GL(I,J)) !+ DT*(FEQ(K,L,I,J)-F(K,L,I,J))/R_TIME
	END DO
	END DO
	IF (IMEX .GT. 0) THEN
	DO I = XR1A,XR1B
	DO J = YR1A,YR1B
	 M = I - XR1A + 1
	 N = J - YR1A + 1
	 RHSL(M,N) = RHS(I,J)
	END DO
	END DO
	!
	CALL IMPLICIT_MTD (XR1A,XR1B,YR1A,YR1B,NXR1,NYR1,K,L,VXP,VYP,VXM,VYM,DT,RHSL,F,FNL)
	DO I = XR1A,XR1B
	DO J = YR1A,YR1B
	 M = I - XR1A + 1
	 N = J - YR1A + 1
	 FN(I,J) = FNL(M,N)
	END DO
	END DO
	ELSE
	DO I = XR1A,XR1B
	DO J = YR1A,YR1B
	 FN(I,J) = F(K,L,I,J) + RHS(I,J)
	END DO
	END DO
	END IF 	
  !*************!
  !     R2      !
  !*************!
  ! BOTTOM WALL
  DO I = XR2A,XR2B
	 J = IWYB
	 PP = ( (VX(K)-UX(I,J+1))**2 + (VY(L)+UY(I,J+1))**2 ) / T(I,J+1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J+1))+THETA)
  END DO
  ! UPPER WALL
  DO I = XR2A,XR2B
     J = YR2B + 1
	 PP = ( (VX(K)-UX(I,J-1))**2 + (VY(L)+UY(I,J-1))**2 ) / T(I,J-1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J-1))+THETA)
  END DO  
  DO I = XR2A,XR2B
  DO J = YR2A,YR2B
	    FLL(I,J) = VXP*F(K,L,I-1,J)+VXM*F(K,L,I,J)
        FLH(I,J) = 0.5D0*VX(K)*(F(K,L,I-1,J)+F(K,L,I,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I,J)-F(K,L,I-1,J)) 
        FL(I,J) = FLL(I,J)+ (PHIA(I-1,J)*(FLH(I,J)-FLL(I,J)))
        FHL(I,J) = VXP*F(K,L,I,J)+VXM*F(K,L,I+1,J)
        FHH(I,J) = 0.5D0*VX(K)*(F(K,L,I,J)+F(K,L,I+1,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I+1,J)-F(K,L,I,J)) 
        FH(I,J)  = FHL(I,J)+ (PHIA(I,J)*(FHH(I,J)-FHL(I,J)))
        GLL(I,J) = VYP*F(K,L,I,J-1)+VYM*F(K,L,I,J)
        GLH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J-1)+F(K,L,I,J))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J)-F(K,L,I,J-1))
        GL(I,J)  = GLL(I,J)+ (PHIB(I,J-1)*(GLH(I,J)-GLL(I,J)))
        GHL(I,J) = VYP*F(K,L,I,J)+VYM*F(K,L,I,J+1)
        GHH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J)+F(K,L,I,J+1))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J+1)-F(K,L,I,J))
        GH2(I,J)  = GHL(I,J)+ (PHIB(I,J)*(GHH(I,J)-GHL(I,J)))
		RHS(I,J) = - DTDX*(FH(I,J)-FL(I,J)) - DTDY*(GH2(I,J)-GL(I,J)) !+ DT*(FEQ(K,L,I,J)-F(K,L,I,J))/R_TIME
	END DO
	END DO
	IF (IMEX .GT. 0) THEN
	DO I = XR2A,XR2B
    DO J = YR2A,YR2B
	 M = I - XR2A + 1
	 N = J - YR2A + 1
	 RHSL(M,N) = RHS(I,J)
	END DO
	END DO	
	CALL IMPLICIT_MTD (XR2A,XR2B,YR2A,YR2B,NXR2,NYR2,K,L,VXP,VYP,VXM,VYM,DT,RHSL,F,FNL)	
	DO I = XR2A,XR2B
    DO J = YR2A,YR2B
	 M = I - XR2A + 1
	 N = J - YR2A + 1
	 FN(I,J) = FNL(M,N)
	END DO
	END DO
	ELSE
	DO I = XR2A,XR2B
    DO J = YR2A,YR2B
	 FN(I,J) = F(K,L,I,J) + RHS(I,J)
	END DO
	END DO
	END IF	
  !**************!
  !      R3      !
  !**************!
  ! BOTTOM WALL
  DO I = XR3A,XR3B
	 J = IWYB
	 PP = ( (VX(K)-UX(I,J+1))**2 + (VY(L)+UY(I,J+1))**2 ) / T(I,J+1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J+1))+THETA)
  END DO
  ! UPPER WALL
  DO I = XR3A,XR3B
     J = YR3B + 1
	 PP = ( (VX(K)-UX(I,J-1))**2 + (VY(L)+UY(I,J-1))**2 ) / T(I,J-1)
     F(K,L,I,J) = 1/((EXP(PP)/Z(I,J-1))+THETA)
  END DO
  ! OUTFLOW BOUNDARY
  DO J = YR3A,YR3B
	 F(K,L,NXT,J) = F(K,L,NXT-2,J) 
  END DO
  DO I = XR3A,XR3B
  DO J = YR3A,YR3B
	    FLL(I,J) = VXP*F(K,L,I-1,J)+VXM*F(K,L,I,J)
        FLH(I,J) = 0.5D0*VX(K)*(F(K,L,I-1,J)+F(K,L,I,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I,J)-F(K,L,I-1,J)) 
        FL(I,J) = FLL(I,J)+ (PHIA(I-1,J)*(FLH(I,J)-FLL(I,J)))
        FHL(I,J) = VXP*F(K,L,I,J)+VXM*F(K,L,I+1,J)
        FHH(I,J) = 0.5D0*VX(K)*(F(K,L,I,J)+F(K,L,I+1,J))-0.5D0*DTDX*VX(K)**2*(F(K,L,I+1,J)-F(K,L,I,J)) 
        FH(I,J)  = FHL(I,J)+ (PHIA(I,J)*(FHH(I,J)-FHL(I,J)))
        GLL(I,J) = VYP*F(K,L,I,J-1)+VYM*F(K,L,I,J)
        GLH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J-1)+F(K,L,I,J))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J)-F(K,L,I,J-1))
        GL(I,J)  = GLL(I,J)+ (PHIB(I,J-1)*(GLH(I,J)-GLL(I,J)))
        GHL(I,J) = VYP*F(K,L,I,J)+VYM*F(K,L,I,J+1)
        GHH(I,J) = 0.5D0*VY(L)*(F(K,L,I,J)+F(K,L,I,J+1))-0.5D0*DTDY*VY(L)**2*(F(K,L,I,J+1)-F(K,L,I,J))
        GH2(I,J)  = GHL(I,J)+ (PHIB(I,J)*(GHH(I,J)-GHL(I,J)))
		RHS(I,J) = - DTDX*(FH(I,J)-FL(I,J)) - DTDY*(GH2(I,J)-GL(I,J)) !+ DT*(FEQ(K,L,I,J)-F(K,L,I,J))/R_TIME
	END DO
	END DO
	IF (IMEX .GT. 0) THEN
	DO I = XR3A,XR3B
    DO J = YR3A,YR3B
	 M = I - XR3A + 1
	 N = J - YR3A + 1
	 RHSL(M,N) = RHS(I,J)
	END DO
	END DO
	CALL IMPLICIT_MTD (XR3A,XR3B,YR3A,YR3B,NXR3,NYR3,K,L,VXP,VYP,VXM,VYM,DT,RHSL,F,FNL)	
	DO I = XR3A,XR3B
    DO J = YR3A,YR3B
	 M = I - XR3A + 1
	 N = J - YR3A + 1
	 FN(I,J) = FNL(M,N)
	END DO
	END DO
	ELSE
	DO I = XR3A,XR3B
    DO J = YR3A,YR3B
	FN(I,J) = F(K,L,I,J) + RHS(I,J)
	END DO
	END DO
	END IF
	!
	DO I = XSALL,XFALL
	DO J = YSALL,YFALL 
	IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
	   F(K,L,I,J) = FN(I,J)	   
	END IF
	END DO
	END DO
END DO
END DO
!

DO I = xsall,xfall
DO J = ysall,yfall
IF ((I.LT.IWXA).OR.(J.GT.IWYB)) THEN
    SR  = 0
    SUX = 0
    SUY = 0
    SE  = 0
      DO K = 1, NV
      DO L = 1, NV
        SR  = SR + CX(K)*CY(L) * F(K,L,I,J)
        SUX = SUX + CX(K)*CY(L) * F(K,L,I,J) * VX(K)
        SUY = SUY + CX(K)*CY(L) * F(K,L,I,J) * VY(L)
        SE  = SE + CX(K)*CY(L) * F(K,L,I,J) * (0.5 * (VX(K)*VX(K) + VY(L)*VY(L)))
      END DO
      END DO
	R(I,J)    = SR
    UX(I,J)   = SUX/SR 
    UY(I,J)   = SUY/SR
    ET(I,J)   = SE
	RR(I,J,3-IZ) = R(I,J) 
END IF      
END DO
END DO

!  ***********************  !
!  CALCULATION OF RESIDUAL	!
!  ***********************  !
  RES = 0
  NORMRES = 0
  DO I = XSALL,XFALL
  DO J = YSALL,YFALL
  IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
	RES = RES + (RR(I,J,3-IZ) - RR(I,J,IZ))**2
  END IF
  END DO
  END DO
  NORMRES = SQRT(RES)
WRITE(100,*) ITER,NORMRES
IZ = 3 - IZ
!
IF (THETA .GT. 0) THEN
    CALL BISECTION (IWXA,IWXB,IWYA,IWYB,XSALL,XFALL,YSALL,YFALL,R,UX,UY,Z,T,P,ET,THETA)
ELSE
	DO I = XSALL,XFALL
	DO J = YSALL,YFALL
	  IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
	  T(I,J) = (2* ET(I,J)/R(I,J))-(UX(I,J)**2+UY(I,J)**2)
	  Z(I,J) = R(I,J)/(PI*T(I,J))
	  P(I,J) = R(I,J)*T(I,J)/2
	  END IF
	END DO
	END DO
END IF
WRITE(*,777) ITER,TIME, R(IWXA-1,IWYB+1)
777	FORMAT (1X,'ITER:',I4,',',1X,'ELAPSED TIME:',F7.4,4X, 'DENSITY AT X=4.0,Y=5.:',F7.4)
IF (ISTOP .EQ. 1) GOTO 2000
ITER = ITER + 1
! ~~~~~~~~~~~~~ !
! WRITING FILES	!
! ~~~~~~~~~~~~~ !
IF (FILEINDX .LE. NUMFILES+1) THEN
!
IF (FILENO .EQ. ITER) THEN
!
WRITE(FILEINDX-1,*) 'ZONE T="L",I=',NYL,',J=',NXL
DO I = XLA,XLB
DO J = YLA,YLB
   WRITE (FILEINDX-1,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!
WRITE(FILEINDX-1,*) 'ZONE T="R1",I=',NYR1,',J=',NXR1+1
DO I = XR1A-1,XR1B
DO J = YR1A,YR1B
   WRITE (FILEINDX-1,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 							   
END DO
!
WRITE(FILEINDX-1,*) 'ZONE T="R2",I=',NYR2,',J=',NXR2+1
DO I = XR2A-1,XR2B
DO J = YR2A,YR2B
   WRITE (FILEINDX-1,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!!
WRITE(FILEINDX-1,*) 'ZONE T="R3",I=',NYR3,',J=',NXR3+1
DO I = XR3A-1,XR3B
DO J = YR3A,YR3B
   WRITE (FILEINDX-1,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!
FILENO   = FILENO	 + GAP
FILEINDX = FILEINDX  + 1
END IF
END IF
3000 CONTINUE
GOTO 1000
!
2000 CONTINUE
! WRITING BLOCKS
WRITE(200,888) 
	!
WRITE(200,*) 'ZONE T="L",I=',NYL,',J=',NXL
DO I = XLA,XLB
DO J = YLA,YLB
   WRITE (200,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!
WRITE(200,*) 'ZONE T="R1",I=',NYR1,',J=',NXR1+1
DO I = XR1A-1,XR1B
DO J = YR1A,YR1B
   WRITE (200,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 							   
END DO
!
WRITE(200,*) 'ZONE T="R2",I=',NYR2,',J=',NXR2+1
DO I = XR2A-1,XR2B
DO J = YR2A,YR2B
   WRITE (200,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!!
WRITE(200,*) 'ZONE T="R3",I=',NYR3,',J=',NXR3+1
DO I = XR3A-1,XR3B
DO J = YR3A,YR3B
   WRITE (200,*) X(I),Y(J) ,R(I,J),UX(I,J),UY(I,J),P(I,J),T(I,J),Z(I,J)
END DO 
END DO
!

STOP
END PROGRAM    
! ******************************************************** !
!                    END OF PROGRAM						   !
! ******************************************************** !
SUBROUTINE IMPLICIT_MTD (XSTART,XFIN,YSTART,YFIN,NX,NY,K,L,VXP,VYP,VXM,VYM,DT,RHS,F,FN)
IMPLICIT NONE		
INTEGER IGH,IMAXGRIDX,IMAXGRIDY
PARAMETER (IGH=32,IMAXGRIDX=400,IMAXGRIDY=400)
INTEGER	K,L,I,J,NX,NY,M,N
REAL(8) DT,VXP,VYP,VXM,VYM
REAL, DIMENSION (IMAXGRIDX,IMAXGRIDY) :: FN,RHS,INVA,INVB,DQ1,DQ
REAL, DIMENSION (IGH,IGH,IMAXGRIDX,IMAXGRIDY) :: F,FLOC
INTEGER XSTART,XFIN,YSTART,YFIN
CALL INV_A (NX,NY,VXP,VYP,DT,INVA)
CALL INV_B (NX,NY,VXM,VYM,DT,INVB)
CALL MULTIPLY (NX,NY,INVA,RHS,DQ1)
CALL MULTIPLY (NX,NY,INVB,DQ1,DQ)
DO I = XSTART,XFIN
DO J = YSTART,YFIN
   M = I - XSTART + 1
   N = J - YSTART + 1
   FLOC(K,L,M,N) = F(K,L,I,J)
END DO
END DO		   
DO I = 1,NX
  DO J = 1,NY
	FN(I,J) = FLOC(K,L,I,J) + DQ(I,J)
  END DO
END DO
RETURN
END SUBROUTINE
!
SUBROUTINE INV_A (NX,NY,VXP,VYP,DT,U)
IMPLICIT NONE
INTEGER IGH,IMAXGRIDX,IMAXGRIDY
PARAMETER (IGH=32,IMAXGRIDX=400,IMAXGRIDY=400)
INTEGER I,J,K,NX,NY
REAL(8) VXP,VYP,DT,BET
REAL,DIMENSION (IMAXGRIDX) :: A, B, C, GAM
REAL,DIMENSION (IMAXGRIDX,IMAXGRIDY) :: U, R 
DO I = 2,NX
	A(I) = DT*(-VXP-VYP)
END DO
DO I = 1,NX
	B(I) = 1+(DT*(VXP+VYP))
END DO
DO	I = 1,NX-1
	C(I) = 0
END DO
DO I = 1,NX
	DO J = 1,NY
		R(I,J) = 0
	END DO
	R(I,I) = 1
END DO
DO  K = 1,NY
	BET=B(2)
	U(1,K) = R(1,K)/BET
	DO  J = 1,NX
		GAM(J) = C(J-1)/BET
		BET=B(J)-A(J)*GAM(J)
		U(J,K) = (R(J,K)-A(J)*U(J-1,K))/BET
	END DO 
	DO  J = NX-1,1,-1
		U(J,K) = U(J,K) - GAM(J+1)*U(J+1,K)
	END DO 
END DO
RETURN
END SUBROUTINE
!
SUBROUTINE INV_B (NX,NY,VXM,VYM,DT,U)
IMPLICIT NONE
INTEGER IGH,IMAXGRIDX,IMAXGRIDY
PARAMETER (IGH=32,IMAXGRIDX=400,IMAXGRIDY=400)
INTEGER I,J,K,NX,NY
REAL(8) VXM,VYM,DT,BET
REAL,DIMENSION (IMAXGRIDX) :: A, B, C, GAM
REAL,DIMENSION (IMAXGRIDX,IMAXGRIDY) :: U, R 
DO I = 2,NX
	A(I) = 0.
END DO
DO I = 1,NX
	B(I) = 1+DT*(-VXM-VYM)
END DO
DO	I = 1,NX-1
	C(I) = DT*(VXM+VYM)
END DO
DO I = 1,NX
	DO J = 2,NY-1
		R(I,J) = 0
	END DO
	R(I,I) = 1
END DO
DO  K = 1,NY
	BET=B(2)
	U(1,K) = R(1,K)/BET
	DO  J = 1,NX
		GAM(J) = C(J-1)/BET
		BET=B(J)-A(J)*GAM(J)
		U(J,K) = (R(J,K)-A(J)*U(J-1,K))/BET
	END DO 
	DO  J = NX-1,1,-1
		U(J,K) = U(J,K) - GAM(J+1)*U(J+1,K)
	END DO 
END DO
RETURN
END SUBROUTINE
!
SUBROUTINE MULTIPLY (NX,NY,A,B,C)
IMPLICIT NONE
INTEGER IGH,IMAXGRIDX,IMAXGRIDY
PARAMETER (IGH=32,IMAXGRIDX=400,IMAXGRIDY=400)
INTEGER I,J,K,NX,NY
REAL,DIMENSION (IMAXGRIDX,IMAXGRIDY) ::	A,B,C
DO I = 1,NX
  DO J = 1,NY
	  C(I,J) = 0.
  END DO
END DO
DO I = 1,NX
  DO J = 1,NY
    DO K = 1,NX
	  C(I,J)=C(I,J) + A(I,K)*B(K,J)
    END DO
  END DO
END DO
RETURN
END SUBROUTINE
!
SUBROUTINE BISECTION (IWXA,IWXB,IWYA,IWYB,XS,XF,YS,YF,R,UX,UY,Z,T,P,ET,THETA)
IMPLICIT NONE
INTEGER IGH,IMAXGRIDX,IMAXGRIDY
PARAMETER (IGH=32,IMAXGRIDX=400,IMAXGRIDY=400) 
INTEGER	I,J,XS,XF,YS,YF,L,SUMMAX,IWXA,IWXB,IWYA,IWYB
REAL,DIMENSION (IMAXGRIDX,IMAXGRIDY) :: R,UX,UY,Z,T,P,ET
REAL(8) ZA,ZB,ZC,GA1,GA2,GB1,GB2,GC1,GC2,PSIA,PSIB,PSIC,THETA,PI 
PI = ATAN2(1.,1.)*4.
SUMMAX = 60
DO I = XS,XF
DO J = YS,YF
IF ((I.LT.IWXA).OR.(I.GT.IWXB).OR.(J.LT.IWYA).OR.(J.GT.IWYB)) THEN
  ZA = 0.0001
  ZB = 0.9
  DO WHILE (ABS(ZA-ZB) .GT. 1E-6)
    GA1 = 0
    GB1 = 0
    GA2 = 0
    GB2 = 0
        DO L = 1, SUMMAX
            IF (THETA .EQ. 1.) THEN      
            GA1 = GA1 + (ZA**L) * (-1)**(L-1)/L
            GB1 = GB1 + (ZB**L) * (-1)**(L-1)/L
            GA2 = GA2 + (ZA**L) * (-1)**(L-1)/(L**2)
            GB2 = GB2 + (ZB**L) * (-1)**(L-1)/(L**2)
            ELSE
            GA1 = GA1 + (ZA**L) /L
            GB1 = GB1 + (ZB**L) /L
            GA2 = GA2 + (ZA**L) /(L**2)
            GB2 = GB2 + (ZB**L) /(L**2)
            END IF    
        END DO
    PSIA = 2*ET(I,J) - (GA2*(R(I,J)/GA1)**2)/PI - R(I,J)*(UX(I,J)*UX(I,J)+UY(I,J)*UY(I,J))
    PSIB = 2*ET(I,J) - (GB2*(R(I,J)/GB1)**2)/PI - R(I,J)*(UX(I,J)*UX(I,J)+UY(I,J)*UY(I,J))
    ZC = (ZA+ZB)/2
    GC1 = 0
    GC2 = 0
        DO L = 1, SUMMAX
            IF (THETA .EQ. 1.) THEN
            GC1 = GC1 + (ZC**L) * (-1)**(L-1)/L
            GC2 = GC2 + (ZC**L) * (-1)**(L-1)/(L**2)
            ELSE 
            GC1 = GC1 + (ZC**L)/L
            GC2 = GC2 + (ZC**L)/(L**2)
            END IF
        END DO
    PSIC = 2*ET(I,J) - (GC2*(R(I,J)/GC1)**2)/PI - R(I,J)*(UX(I,J)*UX(I,J)+UY(I,J)*UY(I,J))
    IF ((PSIA*PSIC) .LT. 0) THEN
        ZB = ZC
    ELSE
        ZA = ZC
    END IF
  END DO
  Z(I,J) = ZC
  T(I,J) = R(I,J)/(PI*GC1)
  P(I,J) = ET(I,J) - 0.5*R(I,J)*(UX(I,J)**2+UY(I,J)**2)
END IF
END DO
END DO
RETURN
END SUBROUTINE